# Based on:
# https://github.com/craigcitro/r-travis/blob/master/sample.travis.yml
# https://github.com/hadley/r-pkgs/blob/master/.travis.yml

language: c

env:
- WARNINGS_ARE_ERRORS=1
global:
  - secure: hbAbKlWMbhusypQVLFI3B4X8nItqMp7S1DLLlgYkQHqnwwcza3KfmXLb5+fLvm8OADxV7jBPtzGDqiHuJy7CYIV8I4dv4MpWaSMwzk3PBdqTSEjIg44QkWAnvT5IyXsEKfMKHyTTc4MekCpd4MN6k+kMhFcoBm/hgvFX7O2jZgg=
  - GH_REF: https://github.com/niranjv/ucscamsms2015.git

before_install:
- curl -OL http://raw.github.com/craigcitro/r-travis/master/scripts/travis-tool.sh
- chmod 755 ./travis-tool.sh
- "./travis-tool.sh bootstrap"

install:
- export PATH="$HOME/pandoc:$PATH"
- mkdir $HOME/pandoc
- curl -O https://s3.amazonaws.com/rstudio-buildtools/pandoc-1.12.3.zip
- unzip -j pandoc-1.12.3.zip pandoc-1.12.3/linux/debian/x86_64/* -d $HOME/pandoc
- chmod +x $HOME/pandoc/pandoc
- pandoc --version
- sudo apt-get install texlive-xetex texlive-latex-extra
- sudo apt-get install lmodern texinfo texlive-base texlive-extra-utils
- sudo apt-get install texlive-fonts-extra texlive-fonts-recommended
- sudo apt-get install texlive-generic-recommended texlive-latex-base
- sudo apt-get install texlive-latex-extra texlive-latex-recommended
- sudo apt-get install fonts-inconsolata
- sudo fc-cache -fv
- "./travis-tool.sh r_binary_install knitr RCurl"
- "./travis-tool.sh github_package   hadley/devtools hadley/bookdown"
- "./travis-tool.sh github_package   niranjv/schedulr@develop"

script:
- Rscript bin/build-report.R

after_failure:
- "./travis-tool.sh dump_logs"

script:
- mkdir temp
- cd temp
- git config --local user.name 'Travis CI'
- git config --local user.email 'niranjanv+github@gmail.com'
- git clone https://github.com/niranjv/ucscamsms2015.git
- cd ucscamsms2015
- git checkout gh-pages
- pwd
- ls
- ls ..
- ls ../..
- cp ../../output/report.pdf .
- git add report.pdf
- git commit report.pdf -m "Add report.PDF"
- git push --force --quiet "https://${GH_TOKEN}@${GH_REF}" master:gh-pages

deploy:
- provider: s3
  access_key_id: AKIAJXAGPD4HZ5IORX2Q
  secret_access_key:
    secure: i7JNkQK84DAxHFZjSTFWYf5+3WcI5Ku09ZMPXfrFjKeIwWcsVHAggSUzyWq/oeNpWxkVLFJdpKIZnddCoOzTxb5qbyrKtyNV76TWoGcAsX78hMnAAtpysLDK3Pw0SLGJoZUvrg/EMMBbfftMfmRyphPh0qHKch//1g+k1PyEtOw=
  acl: public_read
  bucket: io.github.niranjv
  detect_encoding: true
  skip_cleanup: true
  local-dir: output
  upload-dir: ucscamsms2015
  on:
    repo: niranjv/ucscamsms2015
    branch: develop

- provider: s3
  access_key_id: AKIAJXAGPD4HZ5IORX2Q
  secret_access_key:
    secure: i7JNkQK84DAxHFZjSTFWYf5+3WcI5Ku09ZMPXfrFjKeIwWcsVHAggSUzyWq/oeNpWxkVLFJdpKIZnddCoOzTxb5qbyrKtyNV76TWoGcAsX78hMnAAtpysLDK3Pw0SLGJoZUvrg/EMMBbfftMfmRyphPh0qHKch//1g+k1PyEtOw=
  acl: public_read
  bucket: io.github.niranjv
  detect_encoding: true
  skip_cleanup: true
  local-dir: tex
  upload-dir: ucscamsms2015/tex
  on:
    repo: niranjv/ucscamsms2015
    branch: develop

notifications:
  email:
    on_success: change
    on_failure: change
